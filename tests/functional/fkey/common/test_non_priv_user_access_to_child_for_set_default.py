#coding:utf-8

"""
ID:          n/a
TITLE:       Child table must be updated even if current user has no privileges on it but 'SET DEFAULT' present in FK declaration.
DESCRIPTION:
    Child table has column(s) on which FK is declared, with options: ON UPDATE SET DEFAULT and ON DELETE SET DEFAULT.
    Work within a single transaction.
NOTES:
    [21.06.2025] pzotov
    ::: NB :::
    SQL schema name (6.x+), single and double quotes are suppressed in the output.
    See $QA_HOME/README.substitutions.md or https://github.com/FirebirdSQL/firebird-qa/blob/master/README.substitutions.md

    Discussed with Vlad, letters 16.06.2025 13:54 (subj: "#8598: ...")
    Checked on 6.0.0.838; 3.0.13.33813.
"""

import pytest
from firebird.qa import *

# QA_GLOBALS -- dict, is defined in qa/plugin.py, obtain settings
# from act.files_dir/'test_config.ini':
#
addi_subst_settings = QA_GLOBALS['schema_n_quotes_suppress']
addi_subst_tokens = addi_subst_settings['addi_subst']

substitutions = [('[ \t]+', ' '), ('(-)?At trigger\\s+\\S+', 'At trigger')]
for p in addi_subst_tokens.split():
    substitutions.append( (p, '') )

init_sql = """
    recreate table tmain(id int unique using index tmain_uk);
    recreate table tdetl(
        id int generated by default as identity
        ,pid int default -9999
        ,constraint tdetl_fk foreign key(pid) references tmain(id)
            ON DELETE SET DEFAULT
            ON UPDATE SET DEFAULT
    );
    commit;
    insert into tmain(id) values(1111);
    insert into tdetl(pid) values(1111);
    commit;
"""
db = db_factory(init = init_sql)
act = python_act('db', substitutions = substitutions)

tmp_user = user_factory('db', name='tmp_parent_only_accessor', password='123')

@pytest.mark.version('>=3.0')
def test_1(act: Action, tmp_user: User):
    
    test_sql = f"""
        set bail OFF;
        set wng off;
        set list on;
        -- set echo on;
        revoke all on all from {tmp_user.name};
        grant select, insert, update, delete on tmain to {tmp_user.name};
        commit;

        connect '{act.db.dsn}' user '{tmp_user.name}' password '{tmp_user.password}';
        select current_user as whoami from rdb$database;

        -- Update existsing record in parent which have references from detail.
        -- Must PASS because new value of ID equals to DEFAULT value for domain on which FK column is based.
        -- NB: detail table WILL BE CHANGED despite that current user has no any privilege on this table.
        update tmain set id = -9999;
        commit;

        connect '{act.db.dsn}' user '{act.db.user}' password '{act.db.password}';
        select 'point-1' as msg, m.id as tmain_pk, d.id as tdetl_pk, d.pid as tdetl_pid from tmain m left join tdetl d on m.id = d.pid;

        delete from tdetl;
        delete from tmain;
        insert into tmain(id) values(1111);
        insert into tdetl(pid) values(1111);
        commit;

        connect '{act.db.dsn}' user '{tmp_user.name}' password '{tmp_user.password}';

        -- Add record so that both 1111 and -9999 now exists in the parent table:
        insert into tmain(id) values(-9999);

        -- must PASS because default value now exists in just inserted record.
        -- New value tdetl.pid must become -9999.
        -- NB: detail table WILL BE CHANGED despite that current user has no any privilege on this table.
        delete from tmain where id = 1111;
        commit;

        connect '{act.db.dsn}' user '{act.db.user}' password '{act.db.password}';
        select 'point-2' as msg, m.id as tmain_pk, d.id as tdetl_pk, d.pid as tdetl_pid from tmain m left join tdetl d on m.id = d.pid;
    """

    expected_stdout = f"""
        WHOAMI {tmp_user.name.upper()}

        MSG point-1
        TMAIN_PK -9999
        TDETL_PK 1
        TDETL_PID -9999

        MSG point-2
        TMAIN_PK -9999
        TDETL_PK 2
        TDETL_PID -9999
    """

    act.expected_stdout = expected_stdout
    act.isql(switches=['-q'], combine_output = True, input = test_sql)

    assert act.clean_stdout == act.clean_expected_stdout
