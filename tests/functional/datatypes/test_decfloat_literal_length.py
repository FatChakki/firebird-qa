#coding:utf-8

"""
ID:          decfloat.literal-length
ISSUE:       5803
JIRA:        CORE-5535
TITLE:       Literal length currently is limited with 1024 characters (including decimal separator and minus sign if any)
DESCRIPTION:
  See  doc/sql.extensions/README.data_types
    Although length of DECFLOAT(34) literal can exceed 6000 bytes (0.000<6000 zeros>00123)
    implementation limit exists - length of such literal should not exceed 1024 bytes.
FBTEST:      functional.datatypes.decfloat_literal_length
NOTES:
    [08.07.2025] pzotov
    Separated expected output for FB major versions prior/since 6.x.
    No substitutions are used to suppress schema and quotes. Discussed with dimitr, 24.06.2025 12:39.
    Checked on 6.0.0.930; 5.0.3.1668; 4.0.6.3214.
"""

import pytest
from firebird.qa import *

db = db_factory()

test_script = """
    set list on;
    set sqlda_display on;

    -- All of these should PASS (they all have length=1024 bytes):
    -- ###########################################################

    select
    0.10000000000000000000055500000000789000000000000000000000000000000000000000000000000000000000000099900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
    from rdb$database
    ;

    select
    -0.1000000000000000000005550000000078900000000000000000000000000000000000000000000000000000000000009990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
    from rdb$database
    ;

    select
    0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000054321
    from rdb$database
    ;

    select
    -0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000054321
    from rdb$database
    ;


    select
    1230000000000000000000055500000000789000000000000000000000000000000000000000000000000000000000000099900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
    from rdb$database
    ;


    select
    -123000000000000000000005550000000078900000000000000000000000000000000000000000000000000000000000009990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
    from rdb$database
    ;


    -- All of these should FAIL (they all have length=1025 bytes):
    -- ###########################################################

    select
    0.100000000000000000000555000000007890000000000000000000000000000000000000000000000000000000000000999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010
    from rdb$database
    ;

    select
    -0.10000000000000000000055500000000789000000000000000000000000000000000000000000000000000000000000099900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010
    from rdb$database
    ;

    select
    0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000543210
    from rdb$database
    ;

    select
    -0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000543210
    from rdb$database
    ;


    select
    12300000000000000000000555000000007890000000000000000000000000000000000000000000000000000000000000999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010
    from rdb$database
    ;


    select
    -1230000000000000000000055500000000789000000000000000000000000000000000000000000000000000000000000099900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010
    from rdb$database
    ;

"""

substitutions = [ ('^((?!SQLSTATE|sqltype|exception|overflow|truncation|limit|expected|actual|CONSTANT).)*$', ''), ('[ \t]+', ' ') ]
act = isql_act('db', test_script, substitutions = substitutions)


expected_stdout_5x = """
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT 0.1000000000000000000005550000000079
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT -0.1000000000000000000005550000000079
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT 5.4321E-1018
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT -5.4321E-1017
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT 1.230000000000000000000055500000001E+1023
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT -1.230000000000000000000055500000001E+1022
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
"""

expected_stdout_6x = """
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT 0.1000000000000000000005550000000079
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT -0.1000000000000000000005550000000079
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT 5.4321E-1018
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT -5.4321E-1017
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT 1.230000000000000000000055500000001E+1023
    01: sqltype: 32762 DECFLOAT(34) scale: 0 subtype: 0 len: 16
    : name: CONSTANT alias: CONSTANT
    CONSTANT -1.230000000000000000000055500000001E+1022
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
    Statement failed, SQLSTATE = 22001
    arithmetic exception, numeric overflow, or string truncation
    -string right truncation
    -Implementation limit exceeded
    -expected length 1024, actual 1025
"""


@pytest.mark.version('>=4.0')
def test_1(act: Action):
    act.expected_stdout = expected_stdout_5x if act.is_version('<6') else expected_stdout_6x
    act.execute(combine_output = True)
    assert act.clean_stdout == act.clean_expected_stdout
